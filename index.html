<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXCHANGE.SIMULATION.SYSTEM</title>
    <style>
        /* Ryoji Ikeda inspired aesthetic - clinical, precise, data-driven */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000000;
            color: #ffffff;
            line-height: 1.2;
            overflow: hidden;
            user-select: none;
        }

        /* Grid-based layout system */
        .system-container {
            width: 100vw;
            height: 100vh;
            display: grid;
            grid-template-rows: 60px 1fr 40px;
            grid-template-areas: 
                "header"
                "main"
                "status";
        }

        /* Header - clean, technical */
        .system-header {
            grid-area: header;
            background: #000000;
            border-bottom: 1px solid #333333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .system-title {
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .system-controls {
            display: flex;
            gap: 1px;
        }

        /* Ikeda-style buttons */
        .btn {
            background: #000000;
            color: #ffffff;
            border: 1px solid #ffffff;
            padding: 8px 16px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.1s;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 80px;
        }

        .btn:hover {
            background: #ffffff;
            color: #000000;
        }

        .btn:active, .btn.active {
            background: #ffffff;
            color: #000000;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn:disabled:hover {
            background: #000000;
            color: #ffffff;
        }

        /* Main content area - three column grid */
        .main-content {
            grid-area: main;
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            border: 1px solid #333333;
            border-top: none;
            border-bottom: none;
        }

        /* Left panel - controls */
        .controls-panel {
            background: #000000;
            border-right: 1px solid #333333;
            overflow-y: auto;
            font-size: 10px;
        }

        .control-section {
            border-bottom: 1px solid #1a1a1a;
            padding: 15px;
        }

        .control-section h3 {
            font-size: 11px;
            margin-bottom: 10px;
            color: #ffffff;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-section.collapsed .section-content {
            display: none;
        }

        .control-section.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .toggle-icon {
            transition: transform 0.1s;
            font-size: 8px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-size: 9px;
            color: #cccccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 6px 8px;
            background: #000000;
            border: 1px solid #666666;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #ffffff;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* Center panel - heatmap visualization */
        .heatmap-panel {
            background: #000000;
            border-right: 1px solid #333333;
            position: relative;
            overflow: hidden;
        }

        .heatmap-header {
            background: #000000;
            border-bottom: 1px solid #333333;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
        }

        .heatmap-title {
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .heatmap-info {
            font-size: 9px;
            color: #888888;
        }

        .heatmap-canvas-container {
            position: absolute;
            top: 40px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }

        #heatmapCanvas {
            display: block;
            background: #000000;
        }

        /* Right panel - orderbook tables */
        .orderbook-panel {
            background: #000000;
            display: flex;
            flex-direction: column;
        }

        .orderbook-header {
            background: #000000;
            border-bottom: 1px solid #333333;
            padding: 10px 15px;
            height: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .orderbook-title {
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .orderbook-stats {
            display: flex;
            gap: 15px;
            font-size: 9px;
            color: #888888;
        }

        .orderbook-content {
            flex: 1;
            display: grid;
            grid-template-rows: 1fr 1fr;
            overflow: hidden;
        }

        .orderbook-side {
            padding: 10px;
            overflow-y: auto;
            border-bottom: 1px solid #333333;
        }

        .orderbook-side:last-child {
            border-bottom: none;
        }

        .orderbook-side h4 {
            font-size: 10px;
            margin-bottom: 8px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #ffffff;
        }

        .orderbook-level {
            display: grid;
            grid-template-columns: 1fr 1fr;
            padding: 2px 0;
            font-size: 9px;
            font-family: 'Courier New', monospace;
            border-bottom: 1px solid #111111;
        }

        .orderbook-asks .orderbook-level {
            background: linear-gradient(90deg, transparent 0%, rgba(255,0,0,0.1) 100%);
        }

        .orderbook-bids .orderbook-level {
            background: linear-gradient(90deg, transparent 0%, rgba(0,255,0,0.1) 100%);
        }

        .price {
            text-align: right;
            color: #ffffff;
        }

        .quantity {
            text-align: left;
            color: #888888;
            padding-left: 10px;
        }

        /* Status bar */
        .system-status {
            grid-area: status;
            background: #000000;
            border-top: 1px solid #333333;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            align-items: center;
            padding: 0 20px;
            font-size: 9px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-value {
            color: #ffffff;
            font-weight: bold;
        }

        /* Spread profiles */
        .spread-profile {
            background: #111111;
            border: 1px solid #333333;
            margin-bottom: 8px;
            padding: 10px;
        }

        .spread-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .profile-title {
            font-size: 9px;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-remove {
            background: #ff0000;
            color: #ffffff;
            border: none;
            width: 16px;
            height: 16px;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .profile-input {
            width: 100%;
            padding: 3px 5px;
            background: #000000;
            border: 1px solid #444444;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 8px;
        }

        /* Loading and error states */
        .loading, .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 12px;
        }

        .loading.hidden, .error.hidden {
            display: none;
        }

        .error {
            color: #ff4444;
            background: #000000;
            border: 1px solid #ff4444;
            padding: 20px;
            max-width: 400px;
        }

        /* Responsive adjustments */
        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 280px 1fr 320px;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 300px 1fr;
            }
            
            .controls-panel {
                border-right: none;
                border-bottom: 1px solid #333333;
            }
            
            .heatmap-panel {
                border-right: none;
            }
        }

        /* Data visualization specific styles */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 1px;
            background: #333333;
        }

        .data-cell {
            background: #000000;
            padding: 4px;
            text-align: center;
            font-size: 8px;
            border: 1px solid #333333;
        }

        /* Precision indicators */
        .precision-indicator {
            width: 2px;
            height: 2px;
            background: #ffffff;
            display: inline-block;
            margin: 0 1px;
        }

        /* Technical readouts */
        .readout {
            font-family: 'Courier New', monospace;
            font-size: 8px;
            color: #00ff00;
            background: #000000;
            padding: 2px 4px;
            border: 1px solid #004400;
        }
    </style>
</head>
<body>
    <div class="system-container">
        <!-- System Header -->
        <div class="system-header">
            <div class="system-title">EXCHANGE.SIMULATION.SYSTEM</div>
            <div class="system-controls">
                <button id="initBtn" class="btn">INIT</button>
                <button id="startBtn" class="btn" disabled>START</button>
                <button id="stopBtn" class="btn" disabled>STOP</button>
                <button id="resetBtn" class="btn">RESET</button>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="main-content">
            <!-- Left Panel: Controls -->
            <div class="controls-panel">
                <!-- Basic Parameters -->
                <div class="control-section">
                    <h3 onclick="toggleSection(this)">BASIC.PARAMS <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <div class="form-group">
                            <label>AGENTS</label>
                            <input type="number" id="agents" min="1" max="1000" value="10">
                        </div>
                        <div class="form-group">
                            <label>SYMBOL</label>
                            <input type="text" id="symbol" value="BTC/USD">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>SEED</label>
                                <input type="number" id="seed" value="47">
                            </div>
                            <div class="form-group">
                                <label>SPEED</label>
                                <input type="number" id="speedFactor" min="1" max="1000" value="100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Spread Profiles -->
                <div class="control-section">
                    <h3 onclick="toggleSection(this)">SPREAD.PROFILES <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <div style="margin-bottom: 10px; display: flex; gap: 2px;">
                            <button onclick="addPresetProfile('tight')" class="btn" style="font-size: 8px; padding: 4px 8px;">TIGHT</button>
                            <button onclick="addPresetProfile('wide')" class="btn" style="font-size: 8px; padding: 4px 8px;">WIDE</button>
                            <button onclick="addPresetProfile('mixed')" class="btn" style="font-size: 8px; padding: 4px 8px;">MIXED</button>
                        </div>
                        <div id="spreadProfiles"></div>
                        <button id="addSpreadProfile" class="btn" style="font-size: 8px; padding: 4px 8px; width: 100%;">+ ADD</button>
                    </div>
                </div>

                <!-- Order Timeouts -->
                <div class="control-section collapsed">
                    <h3 onclick="toggleSection(this)">ORDER.TIMEOUTS <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <div class="form-group">
                            <label>DISTRIBUTION</label>
                            <select id="timeoutDist">
                                <option value="lognormal">LOG-NORMAL</option>
                                <option value="pareto">PARETO</option>
                                <option value="lognormal_pareto_mix">MIXED</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>MEDIAN (S)</label>
                                <input type="number" id="medianTimeout" min="0.1" max="60" value="5" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>SIGMA</label>
                                <input type="number" id="sigmaTimeout" min="0.1" max="5" value="0.8" step="0.1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>P.ALPHA</label>
                                <input type="number" id="paretoAlpha" min="0.1" max="5" value="1.5" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>P.SCALE</label>
                                <input type="number" id="paretoScale" min="1" max="100" value="5" step="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>TAIL.MIX</label>
                                <input type="number" id="tailMix" min="0" max="1" value="0.1" step="0.05">
                            </div>
                            <div class="form-group">
                                <label>MIN.T (S)</label>
                                <input type="number" id="minTimeoutS" min="0.1" max="60" value="1" step="0.1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>MAX.T (S)</label>
                            <input type="number" id="maxTimeoutS" min="1" max="3600" value="60" step="1">
                        </div>
                    </div>
                </div>

                <!-- Order Sizes -->
                <div class="control-section collapsed">
                    <h3 onclick="toggleSection(this)">ORDER.SIZES <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>MIN.RANGE</label>
                                <input type="number" id="minSizeMin" min="0.001" max="1" value="0.01" step="0.001">
                            </div>
                            <div class="form-group">
                                <label></label>
                                <input type="number" id="minSizeMax" min="0.001" max="1" value="0.1" step="0.001">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>MAX.RANGE</label>
                                <input type="number" id="maxSizeMin" min="0.001" max="10" value="0.1" step="0.001">
                            </div>
                            <div class="form-group">
                                <label></label>
                                <input type="number" id="maxSizeMax" min="0.001" max="10" value="0.5" step="0.001">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Imbalance Parameters -->
                <div class="control-section collapsed">
                    <h3 onclick="toggleSection(this)">IMBALANCE.PARAMS <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>LEVELS</label>
                                <input type="number" id="imbalanceLevelsMin" min="1" max="10" value="1" step="1">
                            </div>
                            <div class="form-group">
                                <label></label>
                                <input type="number" id="imbalanceLevelsMax" min="1" max="10" value="3" step="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ADJ.BPS</label>
                                <input type="number" id="maxImbalanceAdjMin" min="0" max="100" value="2" step="1">
                            </div>
                            <div class="form-group">
                                <label></label>
                                <input type="number" id="maxImbalanceAdjMax" min="0" max="100" value="10" step="1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="control-section collapsed">
                    <h3 onclick="toggleSection(this)">ADVANCED <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>WARMUP (MS)</label>
                                <input type="number" id="warmupMin" min="0" max="5000" value="0" step="10">
                            </div>
                            <div class="form-group">
                                <label></label>
                                <input type="number" id="warmupMax" min="0" max="5000" value="0" step="10">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>SEED.LEVELS</label>
                            <input type="number" id="seedLevels" min="1" max="20" value="5" step="1">
                        </div>
                    </div>
                </div>

                <!-- Heatmap Config -->
                <div class="control-section collapsed">
                    <h3 onclick="toggleSection(this)">HEATMAP.CONFIG <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <div class="form-group">
                            <label>BUFFER.SIZE</label>
                            <input type="number" id="heatmapBufferSize" min="50" max="1000" value="300">
                        </div>
                        <div class="form-group">
                            <label>UPDATE.FREQ</label>
                            <input type="number" id="heatmapUpdateFreq" min="1" max="50" value="5">
                        </div>
                        <div class="form-group">
                            <label>INTENSITY</label>
                            <input type="range" id="heatmapIntensity" min="1" max="10" value="3">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" id="heatmapEnabled" checked style="margin-right: 8px;">
                                ENABLED
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Panel: Heatmap -->
            <div class="heatmap-panel">
                <div class="heatmap-header">
                    <div class="heatmap-title">DEPTH.HEATMAP</div>
                    <div class="heatmap-info">
                        <span>BUFFER: <span id="heatmapBufferUsage">0</span>/<span id="heatmapBufferMax">300</span></span>
                        <span style="margin-left: 10px;">UPDATES: <span id="heatmapUpdateCount">0</span></span>
                    </div>
                </div>
                <div class="heatmap-canvas-container">
                    <canvas id="heatmapCanvas"></canvas>
                    <div id="heatmapLoading" class="loading">
                        <div>INITIALIZING HEATMAP</div>
                        <div style="font-size: 10px; margin-top: 10px; color: #888;">WAITING FOR DATA</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Orderbook -->
            <div class="orderbook-panel">
                <div class="orderbook-header">
                    <div class="orderbook-title">L2.ORDERBOOK</div>
                    <div class="orderbook-stats">
                        <span>SYMBOL: <span id="currentSymbol">-</span></span>
                        <span>UPDATES: <span id="l2UpdateCount">0</span></span>
                    </div>
                </div>
                <div class="orderbook-content">
                    <div class="orderbook-side orderbook-asks">
                        <h4>ASKS</h4>
                        <div id="askLevels"></div>
                    </div>
                    <div class="orderbook-side orderbook-bids">
                        <h4>BIDS</h4>
                        <div id="bidLevels"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status Bar -->
        <div class="system-status">
            <div class="status-item">
                <div class="status-label">STATUS</div>
                <div class="status-value" id="simStatus">IDLE</div>
            </div>
            <div class="status-item">
                <div class="status-label">QUEUE</div>
                <div class="status-value" id="queueSize">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">L2.COUNT</div>
                <div class="status-value" id="updateCount">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">MID.PRICE</div>
                <div class="status-value" id="midPrice">0.00</div>
            </div>
            <div class="status-item">
                <div class="status-label">SPREAD</div>
                <div class="status-value" id="spread">0.00</div>
            </div>
            <div class="status-item">
                <div class="status-label">AGENTS</div>
                <div class="status-value" id="activeAgents">0</div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="error" class="error hidden">
            <div>SYSTEM ERROR</div>
            <div id="errorMessage" style="font-size: 10px; margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        // Integrated Orderbook Heatmap Visualization
        class OrderbookHeatmap {
            constructor() {
                this.canvas = document.getElementById('heatmapCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // State
                this.isPlaying = true;
                this.updateCount = 0;
                this.lastMidPrice = 50000;
                this.lastSpread = 5;
                this.heatmapData = null;
                
                // Configuration
                this.config = {
                    bufferSize: 300,
                    priceLevels: 200,
                    tickSize: 1.0,
                    updateFreq: 5,
                    intensity: 3
                };
                
                // Visual parameters
                this.cellWidth = 3;
                this.cellHeight = 2;
                this.leftMargin = 60;
                this.topMargin = 30;
                
                // Data buffer
                this.dataBuffer = [];
                this.maxBufferSize = 300;
                
                this.setupCanvas();
                this.setupEventListeners();
            }
            
            setupCanvas() {
                this.handleResize();
                this.clearCanvas();
                // Start with synthetic data for demo purposes
                this.startSyntheticData();
            }
            
            setupEventListeners() {
                window.addEventListener('resize', () => this.handleResize());
                
                // Listen for heatmap config changes
                const intensitySlider = document.getElementById('heatmapIntensity');
                if (intensitySlider) {
                    intensitySlider.addEventListener('input', (e) => {
                        this.config.intensity = parseInt(e.target.value);
                    });
                }
                
                const bufferSizeInput = document.getElementById('heatmapBufferSize');
                if (bufferSizeInput) {
                    bufferSizeInput.addEventListener('change', (e) => {
                        this.config.bufferSize = parseInt(e.target.value);
                        this.maxBufferSize = this.config.bufferSize;
                        document.getElementById('heatmapBufferMax').textContent = this.config.bufferSize;
                    });
                }
                
                const updateFreqInput = document.getElementById('heatmapUpdateFreq');
                if (updateFreqInput) {
                    updateFreqInput.addEventListener('change', (e) => {
                        this.config.updateFreq = parseInt(e.target.value);
                    });
                }
            }
            
            handleResize() {
                const container = this.canvas.parentElement;
                const rect = container.getBoundingClientRect();
                
                this.canvas.width = Math.max(400, rect.width - 20);
                this.canvas.height = Math.max(300, rect.height - 20);
                
                // Recalculate cell dimensions
                const availableWidth = this.canvas.width - this.leftMargin - 20;
                const availableHeight = this.canvas.height - this.topMargin - 20;
                
                this.cellWidth = Math.max(2, Math.floor(availableWidth / this.config.bufferSize));
                this.cellHeight = Math.max(1, Math.floor(availableHeight / this.config.priceLevels));
                
                this.redraw();
            }
            
            clearCanvas() {
                this.ctx.fillStyle = '#000000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }
            
            onL2Update(event) {
                if (!this.isPlaying) return;
                
                // Calculate mid price and spread
                if (event.bids && event.bids.length > 0 && event.asks && event.asks.length > 0) {
                    this.lastMidPrice = (event.bids[0].price + event.asks[0].price) / 2;
                    this.lastSpread = event.asks[0].price - event.bids[0].price;
                }
                
                // Hide loading overlay
                const loading = document.getElementById('heatmapLoading');
                if (loading && !loading.classList.contains('hidden')) {
                    loading.classList.add('hidden');
                }
            }
            
            onHeatmapUpdate(heatmapData) {
                if (!this.isPlaying) return;
                
                this.updateCount++;
                document.getElementById('heatmapUpdateCount').textContent = this.updateCount;
                
                // Add new data to buffer
                this.addToDataBuffer(heatmapData);
                
                // Update buffer info
                document.getElementById('heatmapBufferUsage').textContent = this.dataBuffer.length;
                
                this.renderTimeSeriesHeatmap();
            }
            
            addToDataBuffer(heatmapData) {
                this.dataBuffer.push({
                    bidVolumes: [...heatmapData.bidVolumes],
                    askVolumes: [...heatmapData.askVolumes],
                    midPrice: heatmapData.midPrice,
                    timestamp: heatmapData.timestamp || Date.now(),
                    stats: heatmapData.stats
                });
                
                if (this.dataBuffer.length > this.maxBufferSize) {
                    this.dataBuffer.shift();
                }
                
                this.heatmapData = heatmapData;
            }
            
            renderTimeSeriesHeatmap() {
                this.clearCanvas();
                
                if (this.dataBuffer.length === 0) return;
                
                const availableWidth = this.canvas.width - this.leftMargin - 20;
                const maxCols = Math.floor(availableWidth / this.cellWidth);
                
                const numTimePoints = Math.min(this.dataBuffer.length, maxCols);
                const startIndex = Math.max(0, this.dataBuffer.length - numTimePoints);
                
                const { maxVolume } = this.calculateGlobalVolumeStats(startIndex, numTimePoints);
                
                if (maxVolume === 0) return;
                
                // Render each time point as a column
                for (let timeIndex = 0; timeIndex < numTimePoints; timeIndex++) {
                    const dataIndex = startIndex + timeIndex;
                    const data = this.dataBuffer[dataIndex];
                    
                    const x = this.leftMargin + timeIndex * this.cellWidth;
                    this.renderColumn(x, data, maxVolume);
                }
                
                // Draw overlays
                if (this.heatmapData) {
                    this.drawPriceLabels(this.heatmapData);
                    this.drawMidPriceLine(this.heatmapData);
                    this.drawTimeAxis(numTimePoints);
                }
            }
            
            renderColumn(x, data, maxVolume) {
                const { bidVolumes, askVolumes } = data;
                const numLevels = Math.min(bidVolumes.length, askVolumes.length);
                
                for (let level = 0; level < numLevels; level++) {
                    const y = this.topMargin + level * this.cellHeight;
                    
                    // Render bid volume (left half)
                    if (level < bidVolumes.length && bidVolumes[level] > 0) {
                        const intensity = bidVolumes[level] / maxVolume;
                        const color = this.getIntensityColor(intensity, 'bid');
                        this.ctx.fillStyle = color;
                        this.ctx.fillRect(x, y, this.cellWidth / 2, this.cellHeight);
                    }
                    
                    // Render ask volume (right half)
                    if (level < askVolumes.length && askVolumes[level] > 0) {
                        const intensity = askVolumes[level] / maxVolume;
                        const color = this.getIntensityColor(intensity, 'ask');
                        this.ctx.fillStyle = color;
                        this.ctx.fillRect(x + this.cellWidth / 2, y, this.cellWidth / 2, this.cellHeight);
                    }
                }
            }
            
            calculateGlobalVolumeStats(startIndex, numTimePoints) {
                let allVolumes = [];
                
                for (let i = 0; i < numTimePoints; i++) {
                    const data = this.dataBuffer[startIndex + i];
                    
                    data.bidVolumes.forEach(vol => vol > 0 && allVolumes.push(vol));
                    data.askVolumes.forEach(vol => vol > 0 && allVolumes.push(vol));
                }
                
                allVolumes.sort((a, b) => a - b);
                const p95Volume = allVolumes.length > 0 ? 
                    allVolumes[Math.floor(allVolumes.length * 0.95)] : 0;
                
                return { maxVolume: p95Volume };
            }
            
            getIntensityColor(intensity, side) {
                const adjustedIntensity = Math.pow(intensity, 1 / this.config.intensity) * this.config.intensity;
                
                if (adjustedIntensity < 0.1) return '#000000';
                if (adjustedIntensity < 0.3) return '#222222';
                if (adjustedIntensity < 0.5) return '#444444';
                if (adjustedIntensity < 0.7) return '#777777';
                if (adjustedIntensity < 0.9) return '#aaaaaa';
                return '#ffffff';
            }
            
            drawPriceLabels(data) {
                if (!data.priceLabels || !data.midPrice) return;
                
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = '8px Courier New';
                this.ctx.textAlign = 'right';
                
                const midLevel = Math.floor(data.numLevels / 2);
                const labelStep = Math.max(1, Math.floor(data.numLevels / 15));
                
                for (let level = 0; level < data.numLevels; level += labelStep) {
                    if (level < data.priceLabels.length) {
                        const price = data.priceLabels[level];
                        const y = this.topMargin + level * this.cellHeight + this.cellHeight / 2;
                        
                        this.ctx.fillStyle = Math.abs(level - midLevel) < 3 ? '#00ff00' : '#888888';
                        this.ctx.fillText(price.toFixed(1), this.leftMargin - 5, y + 2);
                    }
                }
            }
            
            drawMidPriceLine(data) {
                if (!data.midPrice || !data.numLevels) return;
                
                const midLevel = Math.floor(data.numLevels / 2);
                const y = this.topMargin + midLevel * this.cellHeight + this.cellHeight / 2;
                
                this.ctx.strokeStyle = '#00ff00';
                this.ctx.lineWidth = 1;
                this.ctx.setLineDash([2, 2]);
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.leftMargin, y);
                this.ctx.lineTo(this.canvas.width - 20, y);
                this.ctx.stroke();
                
                this.ctx.setLineDash([]);
            }
            
            drawTimeAxis(numTimePoints) {
                const step = Math.max(1, Math.floor(numTimePoints / 8));
                
                this.ctx.strokeStyle = '#333333';
                this.ctx.lineWidth = 1;
                this.ctx.font = '7px Courier New';
                this.ctx.fillStyle = '#666666';
                this.ctx.textAlign = 'center';
                
                for (let i = 0; i < numTimePoints; i += step) {
                    const x = this.leftMargin + i * this.cellWidth + this.cellWidth / 2;
                    const y1 = this.topMargin - 5;
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, y1);
                    this.ctx.lineTo(x, y1 + 3);
                    this.ctx.stroke();
                    
                    const timeLabel = `T-${numTimePoints - i - 1}`;
                    this.ctx.fillText(timeLabel, x, y1 - 2);
                }
                
                // Highlight current time
                if (numTimePoints > 0) {
                    const x = this.leftMargin + (numTimePoints - 1) * this.cellWidth + this.cellWidth / 2;
                    const y1 = this.topMargin - 10;
                    const y2 = this.topMargin + this.config.priceLevels * this.cellHeight + 10;
                    
                    this.ctx.strokeStyle = '#ffffff';
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, y1);
                    this.ctx.lineTo(x, y2);
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = '#ffffff';
                    this.ctx.fillText('NOW', x, y1 - 2);
                }
            }
            
            // Demo data generation
            startSyntheticData() {
                let counter = 0;
                const interval = setInterval(() => {
                    if (!this.isPlaying) return;
                    
                    if (counter % this.config.updateFreq === 0) {
                        const heatmapData = this.generateSyntheticHeatmapData();
                        this.onHeatmapUpdate(heatmapData);
                    }
                    
                    counter++;
                }, 200);
                
                this.syntheticInterval = interval;
            }
            
            generateSyntheticHeatmapData() {
                const numLevels = this.config.priceLevels;
                const bidVolumes = new Array(numLevels);
                const askVolumes = new Array(numLevels);
                const priceLabels = new Array(numLevels);
                
                const basePrice = 50000 + (Math.sin(Date.now() * 0.0001) * 500);
                const midLevel = Math.floor(numLevels / 2);
                
                const timePhase = Date.now() * 0.001;
                const marketCycle = Math.sin(timePhase * 0.1);
                const volatilityPhase = Math.sin(timePhase * 0.3);
                
                for (let level = 0; level < numLevels; level++) {
                    const distanceFromMid = Math.abs(level - midLevel);
                    const normDistance = distanceFromMid / (numLevels / 2);
                    
                    const baseVolume = Math.exp(-distanceFromMid * 0.1) * 15;
                    const cyclePattern = 1 + 0.5 * Math.sin(timePhase + level * 0.1);
                    const volatilityBoost = 1 + 0.3 * Math.abs(volatilityPhase) * Math.exp(-normDistance * 2);
                    const randomNoise = 0.7 + 0.6 * Math.random();
                    
                    const imbalance = marketCycle * 0.3;
                    const bidBoost = level < midLevel ? (1 + Math.max(0, imbalance)) : (1 + Math.max(0, -imbalance));
                    const askBoost = level > midLevel ? (1 + Math.max(0, -imbalance)) : (1 + Math.max(0, imbalance));
                    
                    bidVolumes[level] = level <= midLevel ? 
                        baseVolume * cyclePattern * volatilityBoost * bidBoost * randomNoise : 0;
                    askVolumes[level] = level >= midLevel ? 
                        baseVolume * cyclePattern * volatilityBoost * askBoost * randomNoise : 0;
                    
                    if (level === midLevel) {
                        bidVolumes[level] *= 0.3;
                        askVolumes[level] *= 0.3;
                    }
                    
                    priceLabels[level] = basePrice + (level - midLevel) * this.config.tickSize;
                }
                
                // Random volume spikes
                if (Math.random() < 0.1) {
                    const spikeLevel = Math.floor(Math.random() * numLevels);
                    const spikeIntensity = 3 + Math.random() * 7;
                    
                    if (bidVolumes[spikeLevel] > 0) bidVolumes[spikeLevel] *= spikeIntensity;
                    if (askVolumes[spikeLevel] > 0) askVolumes[spikeLevel] *= spikeIntensity;
                }
                
                return {
                    bidVolumes, askVolumes, priceLabels,
                    midPrice: basePrice, basePrice, 
                    tickSize: this.config.tickSize,
                    numLevels, timestamp: Date.now()
                };
            }
            
            redraw() {
                if (this.dataBuffer.length > 0) {
                    this.renderTimeSeriesHeatmap();
                } else {
                    this.clearCanvas();
                }
            }
            
            cleanup() {
                if (this.syntheticInterval) {
                    clearInterval(this.syntheticInterval);
                }
            }
        }

        // Global simulation variables
        let Module = null;
        let simulation = null;
        let heatmapViz = null;
        let isInitialized = false;
        let isRunning = false;
        let updateCount = 0;
        let spreadProfileCounter = 0;

        // DOM elements
        const elements = {
            initBtn: document.getElementById('initBtn'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            resetBtn: document.getElementById('resetBtn'),
            simStatus: document.getElementById('simStatus'),
            queueSize: document.getElementById('queueSize'),
            updateCount: document.getElementById('updateCount'),
            currentSymbol: document.getElementById('currentSymbol'),
            l2UpdateCount: document.getElementById('l2UpdateCount'),
            midPrice: document.getElementById('midPrice'),
            spread: document.getElementById('spread'),
            activeAgents: document.getElementById('activeAgents'),
            spreadProfiles: document.getElementById('spreadProfiles'),
            addSpreadProfile: document.getElementById('addSpreadProfile'),
            askLevels: document.getElementById('askLevels'),
            bidLevels: document.getElementById('bidLevels'),
            error: document.getElementById('error'),
            errorMessage: document.getElementById('errorMessage')
        };

        // Utility functions
        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('collapsed');
        }

        function showError(message) {
            elements.error.classList.remove('hidden');
            elements.errorMessage.textContent = message;
            console.error('[System] Error:', message);
        }

        function hideError() {
            elements.error.classList.add('hidden');
        }

        function updateStatus(status) {
            elements.simStatus.textContent = status;
            console.log('[System] Status:', status);
        }

        // Spread profile management
        function createSpreadProfile(profile = null) {
            const profileId = `profile_${++spreadProfileCounter}`;
            const defaultProfile = profile || {
                global_low: 1, global_high: 10,
                alpha_loc: 1.0, beta_loc: 1.0,
                alpha_wid: 1.0, beta_wid: 1.0, weight: 1.0
            };

            const profileHtml = `
                <div class="spread-profile" id="${profileId}">
                    <div class="spread-profile-header">
                        <div class="profile-title">PROFILE.${spreadProfileCounter}</div>
                        <button class="profile-remove" onclick="removeSpreadProfile('${profileId}')">×</button>
                    </div>
                    <div class="profile-grid">
                        <input class="profile-input" name="global_low" type="number" value="${defaultProfile.global_low}" min="1" max="1000" placeholder="LOW">
                        <input class="profile-input" name="global_high" type="number" value="${defaultProfile.global_high}" min="1" max="1000" placeholder="HIGH">
                        <input class="profile-input" name="alpha_loc" type="number" value="${defaultProfile.alpha_loc}" min="0.1" max="10" step="0.1" placeholder="A.LOC">
                        <input class="profile-input" name="beta_loc" type="number" value="${defaultProfile.beta_loc}" min="0.1" max="10" step="0.1" placeholder="B.LOC">
                        <input class="profile-input" name="alpha_wid" type="number" value="${defaultProfile.alpha_wid}" min="0.1" max="10" step="0.1" placeholder="A.WID">
                        <input class="profile-input" name="beta_wid" type="number" value="${defaultProfile.beta_wid}" min="0.1" max="10" step="0.1" placeholder="B.WID">
                    </div>
                    <input class="profile-input" name="weight" type="number" value="${defaultProfile.weight}" min="0.1" max="10" step="0.1" placeholder="WEIGHT" style="margin-top: 5px;">
                </div>
            `;

            elements.spreadProfiles.insertAdjacentHTML('beforeend', profileHtml);
        }

        function removeSpreadProfile(profileId) {
            const profile = document.getElementById(profileId);
            if (profile) profile.remove();
        }

        function getSpreadProfiles() {
            const profiles = [];
            const profileElements = elements.spreadProfiles.querySelectorAll('.spread-profile');
            
            profileElements.forEach(profileElement => {
                const inputs = profileElement.querySelectorAll('input');
                const profile = {};
                inputs.forEach(input => {
                    profile[input.name] = parseFloat(input.value);
                });
                profiles.push(profile);
            });
            
            return profiles;
        }

        function addPresetProfile(preset) {
            const presets = {
                'tight': { global_low: 1, global_high: 3, alpha_loc: 0.5, beta_loc: 4.0, alpha_wid: 0.8, beta_wid: 8.0, weight: 1.0 },
                'wide': { global_low: 20, global_high: 50, alpha_loc: 4.0, beta_loc: 0.5, alpha_wid: 8.0, beta_wid: 0.8, weight: 1.0 },
                'mixed': { global_low: 5, global_high: 15, alpha_loc: 1.5, beta_loc: 1.5, alpha_wid: 2.0, beta_wid: 2.0, weight: 1.0 }
            };
            
            if (presets[preset]) {
                createSpreadProfile(presets[preset]);
            }
        }

        // Input validation
        function validateInputs() {
            const errors = [];
            
            const agents = parseInt(document.getElementById('agents').value);
            if (agents < 1 || agents > 1000) {
                errors.push('Agents must be between 1 and 1000');
            }
            
            const profiles = getSpreadProfiles();
            if (profiles.length === 0) {
                errors.push('At least one spread profile required');
            }
            
            profiles.forEach((profile, index) => {
                if (profile.global_low >= profile.global_high) {
                    errors.push(`Profile ${index + 1}: Low must be < High`);
                }
                if (profile.weight <= 0) {
                    errors.push(`Profile ${index + 1}: Weight must be positive`);
                }
            });
            
            return errors;
        }

        // L2 order book callback
        function onL2Update(event) {
            updateCount++;
            elements.updateCount.textContent = updateCount;
            elements.l2UpdateCount.textContent = updateCount;
            elements.currentSymbol.textContent = event.symbol;

            // Calculate and display mid price and spread
            if (event.bids && event.bids.length > 0 && event.asks && event.asks.length > 0) {
                const midPrice = (event.bids[0].price + event.asks[0].price) / 2;
                const spread = event.asks[0].price - event.bids[0].price;
                
                elements.midPrice.textContent = midPrice.toFixed(2);
                elements.spread.textContent = spread.toFixed(2);
            }

            // Update orderbook display
            const askHtml = event.asks.slice().reverse().map(level => 
                `<div class="orderbook-level">
                    <div class="price">${level.price.toFixed(2)}</div>
                    <div class="quantity">${level.quantity.toFixed(4)}</div>
                </div>`
            ).join('');
            elements.askLevels.innerHTML = askHtml;

            const bidHtml = event.bids.map(level => 
                `<div class="orderbook-level">
                    <div class="price">${level.price.toFixed(2)}</div>
                    <div class="quantity">${level.quantity.toFixed(4)}</div>
                </div>`
            ).join('');
            elements.bidLevels.innerHTML = bidHtml;

            // Update queue size
            if (simulation) {
                elements.queueSize.textContent = simulation.getQueueSize();
            }

            // Forward to heatmap
            if (heatmapViz) {
                heatmapViz.onL2Update(event);
            }
        }

        // Heatmap callback
        function onHeatmapUpdate(heatmapData) {
            if (heatmapViz) {
                heatmapViz.onHeatmapUpdate(heatmapData);
            }
        }

        // Simulation control functions
        function initializeSimulation() {
            hideError();
            
            if (!Module || !Module.ExchangeSimulation) {
                showError('WebAssembly module not loaded');
                return;
            }

            const validationErrors = validateInputs();
            if (validationErrors.length > 0) {
                showError('Validation errors:\n• ' + validationErrors.join('\n• '));
                return;
            }

            try {
                if (simulation) {
                    simulation.cleanup();
                    simulation.delete();
                }

                simulation = new Module.ExchangeSimulation();

                // Configure parameters
                simulation.setAgents(parseInt(document.getElementById('agents').value));
                simulation.setSymbol(document.getElementById('symbol').value);
                simulation.setSeed(parseInt(document.getElementById('seed').value));
                simulation.setSpeedFactor(parseFloat(document.getElementById('speedFactor').value));

                // Timeout parameters
                simulation.setTimeoutDistribution(document.getElementById('timeoutDist').value);
                simulation.setMedianTimeoutSeconds(parseFloat(document.getElementById('medianTimeout').value));
                simulation.setSigmaTimeout(parseFloat(document.getElementById('sigmaTimeout').value));
                simulation.setParetoAlpha(parseFloat(document.getElementById('paretoAlpha').value));
                simulation.setParetoScale(parseFloat(document.getElementById('paretoScale').value));
                simulation.setTailMix(parseFloat(document.getElementById('tailMix').value));
                simulation.setMinTimeoutS(parseFloat(document.getElementById('minTimeoutS').value));
                simulation.setMaxTimeoutS(parseFloat(document.getElementById('maxTimeoutS').value));

                // Order sizes
                simulation.setOrderSizeRanges(
                    parseFloat(document.getElementById('minSizeMin').value),
                    parseFloat(document.getElementById('minSizeMax').value),
                    parseFloat(document.getElementById('maxSizeMin').value),
                    parseFloat(document.getElementById('maxSizeMax').value)
                );

                // Imbalance parameters
                simulation.setImbalanceParams(
                    parseInt(document.getElementById('imbalanceLevelsMin').value),
                    parseInt(document.getElementById('imbalanceLevelsMax').value),
                    parseInt(document.getElementById('maxImbalanceAdjMin').value),
                    parseInt(document.getElementById('maxImbalanceAdjMax').value)
                );

                // Advanced settings
                simulation.setWarmupRangeMs(
                    parseInt(document.getElementById('warmupMin').value),
                    parseInt(document.getElementById('warmupMax').value)
                );
                simulation.setOrderBookSeedLevels(parseInt(document.getElementById('seedLevels').value));

                // Spread profiles
                simulation.clearSpreadProfiles();
                const spreadProfiles = getSpreadProfiles();
                spreadProfiles.forEach(profile => {
                    simulation.addSpreadProfile(
                        profile.global_low, profile.global_high,
                        profile.alpha_loc, profile.beta_loc,
                        profile.alpha_wid, profile.beta_wid,
                        profile.weight
                    );
                });

                // Set callbacks
                simulation.setL2Callback(onL2Update);
                simulation.setHeatmapCallback(onHeatmapUpdate);

                // Heatmap configuration
                if (simulation.setHeatmapBufferSize) {
                    simulation.setHeatmapBufferSize(parseInt(document.getElementById('heatmapBufferSize').value));
                }
                if (simulation.setHeatmapFrequency) {
                    simulation.setHeatmapFrequency(parseInt(document.getElementById('heatmapUpdateFreq').value));
                }
                if (simulation.setHeatmapUpdates) {
                    simulation.setHeatmapUpdates(document.getElementById('heatmapEnabled').checked);
                }

                // Initialize
                const success = simulation.initialize();
                if (!success) {
                    throw new Error('Failed to initialize simulation');
                }

                isInitialized = true;
                updateStatus('READY');
                elements.startBtn.disabled = false;
                elements.activeAgents.textContent = document.getElementById('agents').value;

            } catch (error) {
                showError(`Initialization failed: ${error.message}`);
                isInitialized = false;
            }
        }

        function startSimulation() {
            if (!isInitialized || isRunning) return;

            try {
                updateStatus('STARTING');
                const success = simulation.start();
                
                if (success) {
                    isRunning = true;
                    updateStatus('RUNNING');
                    elements.startBtn.disabled = true;
                    elements.stopBtn.disabled = false;
                    elements.initBtn.disabled = true;
                    
                    // Monitor queue
                    const monitor = setInterval(() => {
                        if (!isRunning) {
                            clearInterval(monitor);
                            return;
                        }
                        
                        const queueSize = simulation.getQueueSize();
                        elements.queueSize.textContent = queueSize;
                        
                        if (queueSize === 0) {
                            stopSimulation();
                            updateStatus('COMPLETE');
                        }
                    }, 100);
                } else {
                    throw new Error('Failed to start simulation');
                }
            } catch (error) {
                showError(`Start failed: ${error.message}`);
                updateStatus('ERROR');
            }
        }

        function stopSimulation() {
            if (!isRunning) return;

            try {
                simulation.stop();
                isRunning = false;
                updateStatus('STOPPED');
                elements.startBtn.disabled = false;
                elements.stopBtn.disabled = true;
                elements.initBtn.disabled = false;
            } catch (error) {
                showError(`Stop failed: ${error.message}`);
            }
        }

        function resetToDefaults() {
            // Reset form values
            document.getElementById('agents').value = 10;
            document.getElementById('symbol').value = 'BTC/USD';
            document.getElementById('seed').value = 47;
            document.getElementById('speedFactor').value = 100;
            
            document.getElementById('timeoutDist').value = 'lognormal';
            document.getElementById('medianTimeout').value = 5;
            document.getElementById('sigmaTimeout').value = 0.8;
            document.getElementById('paretoAlpha').value = 1.5;
            document.getElementById('paretoScale').value = 5;
            document.getElementById('tailMix').value = 0.1;
            document.getElementById('minTimeoutS').value = 1;
            document.getElementById('maxTimeoutS').value = 60;
            
            document.getElementById('minSizeMin').value = 0.01;
            document.getElementById('minSizeMax').value = 0.1;
            document.getElementById('maxSizeMin').value = 0.1;
            document.getElementById('maxSizeMax').value = 0.5;
            
            document.getElementById('imbalanceLevelsMin').value = 1;
            document.getElementById('imbalanceLevelsMax').value = 3;
            document.getElementById('maxImbalanceAdjMin').value = 2;
            document.getElementById('maxImbalanceAdjMax').value = 10;
            
            document.getElementById('warmupMin').value = 0;
            document.getElementById('warmupMax').value = 0;
            document.getElementById('seedLevels').value = 5;
            
            document.getElementById('heatmapBufferSize').value = 300;
            document.getElementById('heatmapUpdateFreq').value = 5;
            document.getElementById('heatmapIntensity').value = 3;
            document.getElementById('heatmapEnabled').checked = true;
            
            // Reset spread profiles
            initializeDefaultSpreadProfiles();
            
            console.log('[System] Reset to defaults');
        }

        function initializeDefaultSpreadProfiles() {
            elements.spreadProfiles.innerHTML = '';
            spreadProfileCounter = 0;
            
            createSpreadProfile({ global_low: 1, global_high: 5, alpha_loc: 0.7, beta_loc: 3.0, alpha_wid: 1.0, beta_wid: 6.0, weight: 0.5 });
            createSpreadProfile({ global_low: 50, global_high: 100, alpha_loc: 3.0, beta_loc: 0.7, alpha_wid: 6.0, beta_wid: 1.0, weight: 0.5 });
        }

        // Event listeners
        elements.initBtn.addEventListener('click', initializeSimulation);
        elements.startBtn.addEventListener('click', startSimulation);
        elements.stopBtn.addEventListener('click', stopSimulation);
        elements.resetBtn.addEventListener('click', resetToDefaults);
        elements.addSpreadProfile.addEventListener('click', () => createSpreadProfile());

        // Initialize system
        function loadModule() {
            console.log('[System] Loading WebAssembly module...');
            
            if (typeof ExchangeSimulationModule === 'undefined') {
                showError('ExchangeSimulationModule not found');
                return;
            }

            ExchangeSimulationModule().then(module => {
                Module = module;
                console.log('[System] WebAssembly module loaded');
                
                // Initialize heatmap visualization
                heatmapViz = new OrderbookHeatmap();
                
                // Initialize default profiles
                initializeDefaultSpreadProfiles();
                
                updateStatus('LOADED');
                
            }).catch(error => {
                showError(`Failed to load WebAssembly: ${error.message}`);
            });
        }

        // Auto-load when page is ready
        window.addEventListener('load', () => {
            setTimeout(loadModule, 100);
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (simulation) {
                simulation.cleanup();
                simulation.delete();
            }
            if (heatmapViz) {
                heatmapViz.cleanup();
            }
        });

        // Keyboard shortcuts for Ikeda-style control
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            switch(e.code) {
                case 'KeyI':
                    if (!isInitialized) initializeSimulation();
                    break;
                case 'Space':
                    e.preventDefault();
                    if (isInitialized && !isRunning) startSimulation();
                    else if (isRunning) stopSimulation();
                    break;
                case 'KeyR':
                    if (e.ctrlKey || e.metaKey) return;
                    e.preventDefault();
                    resetToDefaults();
                    break;
                case 'Escape':
                    if (isRunning) stopSimulation();
                    break;
            }
        });
    </script>

    <!-- Load WebAssembly module -->
    <script src="exchange_simulation.js"></script>
</body>
</html> 