<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exchange Simulation - WebAssembly Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 180px);
        }

        .controls-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .controls-section {
            margin-bottom: 25px;
        }

        .controls-section.collapsible h3 {
            cursor: pointer;
            user-select: none;
            padding: 10px 15px;
            margin: -10px -15px 15px -15px;
            border-radius: 8px;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls-section.collapsible h3:hover {
            background: #f7fafc;
        }

        .controls-section.collapsible.collapsed .section-content {
            display: none;
        }

        .controls-section.collapsible.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .toggle-icon {
            transition: transform 0.2s;
            font-size: 0.8rem;
        }

        .section-content {
            display: block;
        }

        .controls-section h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2d3748;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group .btn {
            flex: 1;
        }

        .display-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .display-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .display-header h2 {
            margin-bottom: 10px;
        }

        .status-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .status-item {
            text-align: center;
        }

        .status-item .label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .status-item .value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .orderbook-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .orderbook {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100%;
        }

        .orderbook-side {
            border-radius: 10px;
            padding: 15px;
        }

        .orderbook-asks {
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
        }

        .orderbook-bids {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
        }

        .orderbook-side h3 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.2rem;
            color: #2d3748;
        }

        .orderbook-level {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 8px 12px;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .price {
            text-align: right;
            font-weight: bold;
        }

        .quantity {
            text-align: left;
            color: #4a5568;
        }

        .status-bar {
            background: #f7fafc;
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
        }

        .status-message {
            font-size: 14px;
            color: #4a5568;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .controls-panel {
                max-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .orderbook {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .status-info {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .btn.small {
            padding: 6px 12px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .spread-profile {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .spread-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .spread-profile-title {
            font-weight: 600;
            color: #2d3748;
        }

        .profile-remove-btn {
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .profile-remove-btn:hover {
            background: #c53030;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .profile-form-group {
            margin-bottom: 10px;
        }

        .profile-form-group label {
            display: block;
            margin-bottom: 3px;
            font-size: 12px;
            font-weight: 500;
            color: #4a5568;
        }

        .profile-form-group input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 12px;
        }

        .profile-preview {
            background: #edf2f7;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 11px;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏦 Exchange Simulation</h1>
            <p>Real-time order book simulation powered by WebAssembly</p>
        </div>

        <div id="loading" class="loading">
            <h3>Loading WebAssembly module...</h3>
            <p>Please wait while the simulation engine initializes.</p>
        </div>

        <div id="error" class="error hidden"></div>

        <div id="mainContent" class="main-grid hidden">
            <div class="controls-panel">
                <div class="controls-section">
                    <h3>📊 Basic Parameters</h3>
                    <div class="form-group">
                        <label for="agents">Number of Agents</label>
                        <input type="number" id="agents" min="1" max="1000" value="10">
                    </div>
                    <div class="form-group">
                        <label for="symbol">Trading Symbol</label>
                        <input type="text" id="symbol" value="BTC/USD">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="seed">Random Seed</label>
                            <input type="number" id="seed" value="47">
                        </div>
                        <div class="form-group">
                            <label for="speedFactor">Speed Factor</label>
                            <input type="number" id="speedFactor" min="1" max="1000" value="100" step="10">
                        </div>
                    </div>
                </div>

                <div class="controls-section collapsible">
                    <h3 onclick="toggleSection(this)">📈 Spread Profiles <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <p style="font-size: 12px; color: #718096; margin-bottom: 15px;">
                            Spread profiles control how agents choose their bid-ask spreads using Beta distributions. 
                            <strong>Global Low/High:</strong> min/max spread in basis points. 
                            <strong>Alpha/Beta Location:</strong> shape parameters for spread center. 
                            <strong>Alpha/Beta Width:</strong> shape parameters for spread range.
                        </p>
                        <div style="margin-bottom: 10px;">
                            <button type="button" onclick="addPresetProfile('tight')" class="btn btn-secondary small">+ Tight Spreads</button>
                            <button type="button" onclick="addPresetProfile('wide')" class="btn btn-secondary small">+ Wide Spreads</button>
                            <button type="button" onclick="addPresetProfile('mixed')" class="btn btn-secondary small">+ Mixed Profile</button>
                        </div>
                        <div id="spreadProfiles">
                            <!-- Dynamic spread profiles will be inserted here -->
                        </div>
                        <button type="button" id="addSpreadProfile" class="btn btn-secondary small">+ Custom Profile</button>
                    </div>
                </div>

                <div class="controls-section collapsible">
                    <h3 onclick="toggleSection(this)">⏱️ Order Timeouts <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <p style="font-size: 12px; color: #718096; margin-bottom: 15px;">
                            Configure how long orders stay in the market before expiring. 
                            <strong>Log-normal:</strong> symmetric distribution. <strong>Pareto:</strong> power-law with long tails. 
                            <strong>Mixed:</strong> combination of both distributions.
                        </p>
                        <div class="form-group">
                            <label for="timeoutDist">Distribution</label>
                            <select id="timeoutDist">
                                <option value="lognormal">Log-normal</option>
                                <option value="pareto">Pareto</option>
                                <option value="lognormal_pareto_mix">Mixed</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="medianTimeout">Median (s)</label>
                                <input type="number" id="medianTimeout" min="0.1" max="60" value="5" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="sigmaTimeout">Sigma</label>
                                <input type="number" id="sigmaTimeout" min="0.1" max="5" value="0.8" step="0.1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="paretoAlpha">Pareto Alpha</label>
                                <input type="number" id="paretoAlpha" min="0.1" max="5" value="1.5" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="paretoScale">Pareto Scale</label>
                                <input type="number" id="paretoScale" min="1" max="100" value="5" step="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tailMix">Tail Mix</label>
                                <input type="number" id="tailMix" min="0" max="1" value="0.1" step="0.05">
                            </div>
                            <div class="form-group">
                                <label for="minTimeoutS">Min Timeout (s)</label>
                                <input type="number" id="minTimeoutS" min="0.1" max="60" value="1" step="0.1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="maxTimeoutS">Max Timeout (s)</label>
                            <input type="number" id="maxTimeoutS" min="1" max="3600" value="60" step="1">
                        </div>
                    </div>
                </div>

                <div class="controls-section collapsible">
                    <h3 onclick="toggleSection(this)">💰 Order Sizes <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <p style="font-size: 12px; color: #718096; margin-bottom: 15px;">
                            Define the range of order sizes that agents can place. Each agent will randomly choose 
                            min and max order sizes within these ranges.
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="minSizeMin">Min Size Range</label>
                                <input type="number" id="minSizeMin" min="0.001" max="1" value="0.01" step="0.001">
                            </div>
                            <div class="form-group">
                                <label for="minSizeMax"></label>
                                <input type="number" id="minSizeMax" min="0.001" max="1" value="0.1" step="0.001">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="maxSizeMin">Max Size Range</label>
                                <input type="number" id="maxSizeMin" min="0.001" max="10" value="0.1" step="0.001">
                            </div>
                            <div class="form-group">
                                <label for="maxSizeMax"></label>
                                <input type="number" id="maxSizeMax" min="0.001" max="10" value="0.5" step="0.001">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="controls-section collapsible">
                    <h3 onclick="toggleSection(this)">⚖️ Imbalance Parameters <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <p style="font-size: 12px; color: #718096; margin-bottom: 15px;">
                            Agents adjust their quotes based on order book imbalance. 
                            <strong>Levels:</strong> how many book levels to consider. 
                            <strong>Max Adj BPS:</strong> maximum spread adjustment in basis points.
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="imbalanceLevelsMin">Levels Range</label>
                                <input type="number" id="imbalanceLevelsMin" min="1" max="10" value="1" step="1">
                            </div>
                            <div class="form-group">
                                <label for="imbalanceLevelsMax"></label>
                                <input type="number" id="imbalanceLevelsMax" min="1" max="10" value="3" step="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="maxImbalanceAdjMin">Max Adj BPS Range</label>
                                <input type="number" id="maxImbalanceAdjMin" min="0" max="100" value="2" step="1">
                            </div>
                            <div class="form-group">
                                <label for="maxImbalanceAdjMax"></label>
                                <input type="number" id="maxImbalanceAdjMax" min="0" max="100" value="10" step="1">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="controls-section collapsible">
                    <h3 onclick="toggleSection(this)">🔧 Advanced Settings <span class="toggle-icon">▼</span></h3>
                    <div class="section-content">
                        <p style="font-size: 12px; color: #718096; margin-bottom: 15px;">
                            Fine-tune simulation behavior. 
                            <strong>Warmup Range:</strong> time to let each agent settle before adding the next one. 
                            <strong>Seed Levels:</strong> initial order book depth when simulation starts.
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="warmupMin">Warmup Range (ms)</label>
                                <input type="number" id="warmupMin" min="0" max="5000" value="0" step="10">
                            </div>
                            <div class="form-group">
                                <label for="warmupMax"></label>
                                <input type="number" id="warmupMax" min="0" max="5000" value="0" step="10">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="seedLevels">Order Book Seed Levels</label>
                            <input type="number" id="seedLevels" min="1" max="20" value="5" step="1">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button id="initBtn" class="btn btn-primary">Initialize</button>
                    <button id="startBtn" class="btn btn-secondary" disabled>Start</button>
                    <button id="stopBtn" class="btn btn-danger" disabled>Stop</button>
                </div>
                <div class="button-group" style="margin-top: 10px;">
                    <button id="resetBtn" class="btn btn-secondary" onclick="resetToDefaults()">🔄 Reset to Defaults</button>
                </div>
            </div>

            <div class="display-panel">
                <div class="display-header">
                    <h2>📈 Live Order Book</h2>
                    <div class="status-info">
                        <div class="status-item">
                            <div class="label">Status</div>
                            <div id="simStatus" class="value">Idle</div>
                        </div>
                        <div class="status-item">
                            <div class="label">Queue Size</div>
                            <div id="queueSize" class="value">0</div>
                        </div>
                        <div class="status-item">
                            <div class="label">L2 Updates</div>
                            <div id="updateCount" class="value">0</div>
                        </div>
                        <div class="status-item">
                            <div class="label">Symbol</div>
                            <div id="currentSymbol" class="value">-</div>
                        </div>
                    </div>
                </div>

                <div class="orderbook-container">
                    <div id="noData" class="loading">
                        <h3>No order book data</h3>
                        <p>Initialize and start the simulation to see live data.</p>
                    </div>

                    <div id="orderbook" class="orderbook hidden">
                        <div class="orderbook-side orderbook-asks">
                            <h3>🔴 ASKS (Sell Orders)</h3>
                            <div id="askLevels"></div>
                        </div>
                        <div class="orderbook-side orderbook-bids">
                            <h3>🟢 BIDS (Buy Orders)</h3>
                            <div id="bidLevels"></div>
                        </div>
                    </div>
                </div>

                <div class="status-bar">
                    <div id="statusMessage" class="status-message">Ready to initialize simulation.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let Module = null;
        let simulation = null;
        let isInitialized = false;
        let isRunning = false;
        let updateCount = 0;
        let lastLoggedQueueSize = 0;
        let spreadProfileCounter = 0;

        // DOM elements
        const elements = {
            loading: document.getElementById('loading'),
            error: document.getElementById('error'),
            mainContent: document.getElementById('mainContent'),
            initBtn: document.getElementById('initBtn'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            simStatus: document.getElementById('simStatus'),
            queueSize: document.getElementById('queueSize'),
            updateCount: document.getElementById('updateCount'),
            currentSymbol: document.getElementById('currentSymbol'),
            statusMessage: document.getElementById('statusMessage'),
            noData: document.getElementById('noData'),
            orderbook: document.getElementById('orderbook'),
            askLevels: document.getElementById('askLevels'),
            bidLevels: document.getElementById('bidLevels'),
            spreadProfiles: document.getElementById('spreadProfiles'),
            addSpreadProfile: document.getElementById('addSpreadProfile')
        };

        // Collapsible section functionality
        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('collapsed');
        }

        // Spread profile management
        function createSpreadProfile(profile = null) {
            const profileId = `profile_${++spreadProfileCounter}`;
            const defaultProfile = profile || {
                global_low: 1,
                global_high: 10,
                alpha_loc: 1.0,
                beta_loc: 1.0,
                alpha_wid: 1.0,
                beta_wid: 1.0,
                weight: 1.0
            };

            const profileHtml = `
                <div class="spread-profile" id="${profileId}">
                    <div class="spread-profile-header">
                        <div class="spread-profile-title">Profile ${spreadProfileCounter}</div>
                        <button class="profile-remove-btn" onclick="removeSpreadProfile('${profileId}')">×</button>
                    </div>
                    <div class="profile-grid">
                        <div class="profile-form-group">
                            <label>Global Low (BPS)</label>
                            <input type="number" name="global_low" value="${defaultProfile.global_low}" min="1" max="1000" step="1">
                        </div>
                        <div class="profile-form-group">
                            <label>Global High (BPS)</label>
                            <input type="number" name="global_high" value="${defaultProfile.global_high}" min="1" max="1000" step="1">
                        </div>
                        <div class="profile-form-group">
                            <label>Alpha Location</label>
                            <input type="number" name="alpha_loc" value="${defaultProfile.alpha_loc}" min="0.1" max="10" step="0.1">
                        </div>
                        <div class="profile-form-group">
                            <label>Beta Location</label>
                            <input type="number" name="beta_loc" value="${defaultProfile.beta_loc}" min="0.1" max="10" step="0.1">
                        </div>
                        <div class="profile-form-group">
                            <label>Alpha Width</label>
                            <input type="number" name="alpha_wid" value="${defaultProfile.alpha_wid}" min="0.1" max="10" step="0.1">
                        </div>
                        <div class="profile-form-group">
                            <label>Beta Width</label>
                            <input type="number" name="beta_wid" value="${defaultProfile.beta_wid}" min="0.1" max="10" step="0.1">
                        </div>
                    </div>
                    <div class="profile-form-group">
                        <label>Weight</label>
                        <input type="number" name="weight" value="${defaultProfile.weight}" min="0.1" max="10" step="0.1">
                    </div>
                    <div class="profile-preview">
                        Spread: ${defaultProfile.global_low}-${defaultProfile.global_high} BPS, 
                        Location: α=${defaultProfile.alpha_loc} β=${defaultProfile.beta_loc}, 
                        Width: α=${defaultProfile.alpha_wid} β=${defaultProfile.beta_wid}, 
                        Weight: ${defaultProfile.weight}
                    </div>
                </div>
            `;

            elements.spreadProfiles.insertAdjacentHTML('beforeend', profileHtml);
            updateProfilePreview(profileId);
            
            // Add event listeners for live preview updates
            const profileElement = document.getElementById(profileId);
            const inputs = profileElement.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', () => updateProfilePreview(profileId));
            });
        }

        function removeSpreadProfile(profileId) {
            const profile = document.getElementById(profileId);
            if (profile) {
                profile.remove();
            }
        }

        function updateProfilePreview(profileId) {
            const profile = document.getElementById(profileId);
            const inputs = profile.querySelectorAll('input');
            const values = {};
            inputs.forEach(input => {
                values[input.name] = parseFloat(input.value);
            });

            const preview = profile.querySelector('.profile-preview');
            preview.textContent = `Spread: ${values.global_low}-${values.global_high} BPS, ` +
                                  `Location: α=${values.alpha_loc} β=${values.beta_loc}, ` +
                                  `Width: α=${values.alpha_wid} β=${values.beta_wid}, ` +
                                  `Weight: ${values.weight}`;
        }

        function getSpreadProfiles() {
            const profiles = [];
            const profileElements = elements.spreadProfiles.querySelectorAll('.spread-profile');
            
            profileElements.forEach(profileElement => {
                const inputs = profileElement.querySelectorAll('input');
                const profile = {};
                inputs.forEach(input => {
                    profile[input.name] = parseFloat(input.value);
                });
                profiles.push(profile);
            });
            
            return profiles;
        }

        // Input validation
        function validateInputs() {
            const errors = [];
            
            // Basic parameter validation
            const agents = parseInt(document.getElementById('agents').value);
            if (agents < 1 || agents > 1000) {
                errors.push('Number of agents must be between 1 and 1000');
            }
            
            // Order size validation
            const minSizeMin = parseFloat(document.getElementById('minSizeMin').value);
            const minSizeMax = parseFloat(document.getElementById('minSizeMax').value);
            const maxSizeMin = parseFloat(document.getElementById('maxSizeMin').value);
            const maxSizeMax = parseFloat(document.getElementById('maxSizeMax').value);
            
            if (minSizeMin >= minSizeMax) {
                errors.push('Min size range: first value must be less than second value');
            }
            if (maxSizeMin >= maxSizeMax) {
                errors.push('Max size range: first value must be less than second value');
            }
            if (minSizeMax > maxSizeMin) {
                errors.push('Min size max should not exceed max size min');
            }
            
            // Timeout validation
            const minTimeout = parseFloat(document.getElementById('minTimeoutS').value);
            const maxTimeout = parseFloat(document.getElementById('maxTimeoutS').value);
            if (minTimeout >= maxTimeout) {
                errors.push('Min timeout must be less than max timeout');
            }
            
            // Imbalance validation
            const imbalanceLevelsMin = parseInt(document.getElementById('imbalanceLevelsMin').value);
            const imbalanceLevelsMax = parseInt(document.getElementById('imbalanceLevelsMax').value);
            if (imbalanceLevelsMin > imbalanceLevelsMax) {
                errors.push('Imbalance levels: min must be ≤ max');
            }
            
            const maxImbalanceAdjMin = parseInt(document.getElementById('maxImbalanceAdjMin').value);
            const maxImbalanceAdjMax = parseInt(document.getElementById('maxImbalanceAdjMax').value);
            if (maxImbalanceAdjMin > maxImbalanceAdjMax) {
                errors.push('Max imbalance adjustment: min must be ≤ max');
            }
            
            // Warmup validation
            const warmupMin = parseInt(document.getElementById('warmupMin').value);
            const warmupMax = parseInt(document.getElementById('warmupMax').value);
            if (warmupMin > warmupMax) {
                errors.push('Warmup range: min must be ≤ max');
            }
            
            // Spread profile validation
            const profiles = getSpreadProfiles();
            if (profiles.length === 0) {
                errors.push('At least one spread profile is required');
            }
            
            profiles.forEach((profile, index) => {
                if (profile.global_low >= profile.global_high) {
                    errors.push(`Spread profile ${index + 1}: Global low must be less than global high`);
                }
                if (profile.weight <= 0) {
                    errors.push(`Spread profile ${index + 1}: Weight must be positive`);
                }
            });
            
            return errors;
        }

        // Preset spread profiles
        function addPresetProfile(preset) {
            const presets = {
                'tight': { global_low: 1, global_high: 3, alpha_loc: 0.5, beta_loc: 4.0, alpha_wid: 0.8, beta_wid: 8.0, weight: 1.0 },
                'wide': { global_low: 20, global_high: 50, alpha_loc: 4.0, beta_loc: 0.5, alpha_wid: 8.0, beta_wid: 0.8, weight: 1.0 },
                'mixed': { global_low: 5, global_high: 15, alpha_loc: 1.5, beta_loc: 1.5, alpha_wid: 2.0, beta_wid: 2.0, weight: 1.0 }
            };
            
            if (presets[preset]) {
                createSpreadProfile(presets[preset]);
            }
        }

        // Reset to default values
        function resetToDefaults() {
            // Basic parameters
            document.getElementById('agents').value = 10;
            document.getElementById('symbol').value = 'BTC/USD';
            document.getElementById('seed').value = 47;
            document.getElementById('speedFactor').value = 100;
            
            // Order timeout parameters
            document.getElementById('timeoutDist').value = 'lognormal';
            document.getElementById('medianTimeout').value = 5;
            document.getElementById('sigmaTimeout').value = 0.8;
            document.getElementById('paretoAlpha').value = 1.5;
            document.getElementById('paretoScale').value = 5;
            document.getElementById('tailMix').value = 0.1;
            document.getElementById('minTimeoutS').value = 1;
            document.getElementById('maxTimeoutS').value = 60;
            
            // Order size parameters
            document.getElementById('minSizeMin').value = 0.01;
            document.getElementById('minSizeMax').value = 0.1;
            document.getElementById('maxSizeMin').value = 0.1;
            document.getElementById('maxSizeMax').value = 0.5;
            
            // Imbalance parameters
            document.getElementById('imbalanceLevelsMin').value = 1;
            document.getElementById('imbalanceLevelsMax').value = 3;
            document.getElementById('maxImbalanceAdjMin').value = 2;
            document.getElementById('maxImbalanceAdjMax').value = 10;
            
            // Advanced settings
            document.getElementById('warmupMin').value = 0;
            document.getElementById('warmupMax').value = 0;
            document.getElementById('seedLevels').value = 5;
            
            // Reset spread profiles to defaults
            initializeDefaultSpreadProfiles();
            
            console.log('[JavaScript] Settings reset to defaults');
        }

        // Initialize default spread profiles
        function initializeDefaultSpreadProfiles() {
            // Clear existing profiles
            elements.spreadProfiles.innerHTML = '';
            spreadProfileCounter = 0;
            
            // Add default profiles
            createSpreadProfile({ global_low: 1, global_high: 5, alpha_loc: 0.7, beta_loc: 3.0, alpha_wid: 1.0, beta_wid: 6.0, weight: 0.5 });
            createSpreadProfile({ global_low: 50, global_high: 100, alpha_loc: 3.0, beta_loc: 0.7, alpha_wid: 6.0, beta_wid: 1.0, weight: 0.5 });
        }

        // Error handling
        function showError(message) {
            elements.error.textContent = message;
            elements.error.classList.remove('hidden');
            elements.loading.classList.add('hidden');
        }

        // Status updates
        function updateStatus(status) {
            elements.simStatus.textContent = status;
            elements.statusMessage.textContent = `Simulation status: ${status}`;
        }

        function updateQueueSize() {
            if (simulation) {
                elements.queueSize.textContent = simulation.getQueueSize();
            }
        }

        // L2 order book callback
        function onL2Update(event) {
            console.log('[JavaScript] L2 callback called!', event);
            console.log('[JavaScript] Symbol:', event.symbol);
            console.log('[JavaScript] Bids count:', event.bids ? event.bids.length : 'undefined');
            console.log('[JavaScript] Asks count:', event.asks ? event.asks.length : 'undefined');
            
            if (event.bids && event.bids.length > 0) {
                console.log('[JavaScript] Best bid:', event.bids[0]);
            }
            if (event.asks && event.asks.length > 0) {
                console.log('[JavaScript] Best ask:', event.asks[0]);
            }
            
            updateCount++;
            elements.updateCount.textContent = updateCount;
            elements.currentSymbol.textContent = event.symbol;

            // Show order book if hidden
            if (elements.orderbook.classList.contains('hidden')) {
                console.log('[JavaScript] Showing order book for first time');
                elements.noData.classList.add('hidden');
                elements.orderbook.classList.remove('hidden');
            }

            // Update asks (reverse order for display)
            const askHtml = event.asks.slice().reverse().map(level => 
                `<div class="orderbook-level">
                    <div class="price">${level.price.toFixed(2)}</div>
                    <div class="quantity">${level.quantity.toFixed(4)}</div>
                </div>`
            ).join('');
            elements.askLevels.innerHTML = askHtml;

            // Update bids
            const bidHtml = event.bids.map(level => 
                `<div class="orderbook-level">
                    <div class="price">${level.price.toFixed(2)}</div>
                    <div class="quantity">${level.quantity.toFixed(4)}</div>
                </div>`
            ).join('');
            elements.bidLevels.innerHTML = bidHtml;

            // Update queue size
            updateQueueSize();
            
            console.log('[JavaScript] L2 callback completed, updateCount:', updateCount);
        }

        // Simulation control functions
        function initializeSimulation() {
            console.log('[JavaScript] initializeSimulation called');
            
            if (!Module || !Module.ExchangeSimulation) {
                showError('WebAssembly module not loaded properly');
                return;
            }

            // Validate inputs first
            const validationErrors = validateInputs();
            if (validationErrors.length > 0) {
                showError('Validation errors:\n• ' + validationErrors.join('\n• '));
                return;
            }

            try {
                // Create new simulation instance
                if (simulation) {
                    simulation.cleanup();
                    simulation.delete();
                }

                console.log('[JavaScript] Creating new ExchangeSimulation instance');
                simulation = new Module.ExchangeSimulation();

                // Configure basic parameters
                const agentCount = parseInt(document.getElementById('agents').value);
                const symbol = document.getElementById('symbol').value;
                console.log('[JavaScript] Configuring simulation: agents=' + agentCount + ', symbol=' + symbol);
                
                simulation.setAgents(agentCount);
                simulation.setSymbol(symbol);
                simulation.setSeed(parseInt(document.getElementById('seed').value));
                simulation.setSpeedFactor(parseFloat(document.getElementById('speedFactor').value));

                // Configure order timeout parameters
                simulation.setTimeoutDistribution(document.getElementById('timeoutDist').value);
                simulation.setMedianTimeoutSeconds(parseFloat(document.getElementById('medianTimeout').value));
                simulation.setSigmaTimeout(parseFloat(document.getElementById('sigmaTimeout').value));
                simulation.setParetoAlpha(parseFloat(document.getElementById('paretoAlpha').value));
                simulation.setParetoScale(parseFloat(document.getElementById('paretoScale').value));
                simulation.setTailMix(parseFloat(document.getElementById('tailMix').value));
                simulation.setMinTimeoutS(parseFloat(document.getElementById('minTimeoutS').value));
                simulation.setMaxTimeoutS(parseFloat(document.getElementById('maxTimeoutS').value));

                // Configure order size ranges
                const minSizeMin = parseFloat(document.getElementById('minSizeMin').value);
                const minSizeMax = parseFloat(document.getElementById('minSizeMax').value);
                const maxSizeMin = parseFloat(document.getElementById('maxSizeMin').value);
                const maxSizeMax = parseFloat(document.getElementById('maxSizeMax').value);
                simulation.setOrderSizeRanges(minSizeMin, minSizeMax, maxSizeMin, maxSizeMax);

                // Configure imbalance parameters
                const imbalanceLevelsMin = parseInt(document.getElementById('imbalanceLevelsMin').value);
                const imbalanceLevelsMax = parseInt(document.getElementById('imbalanceLevelsMax').value);
                const maxImbalanceAdjMin = parseInt(document.getElementById('maxImbalanceAdjMin').value);
                const maxImbalanceAdjMax = parseInt(document.getElementById('maxImbalanceAdjMax').value);
                simulation.setImbalanceParams(imbalanceLevelsMin, imbalanceLevelsMax, maxImbalanceAdjMin, maxImbalanceAdjMax);

                // Configure advanced settings
                const warmupMin = parseInt(document.getElementById('warmupMin').value);
                const warmupMax = parseInt(document.getElementById('warmupMax').value);
                simulation.setWarmupRangeMs(warmupMin, warmupMax);
                simulation.setOrderBookSeedLevels(parseInt(document.getElementById('seedLevels').value));

                // Configure spread profiles
                console.log('[JavaScript] Configuring spread profiles...');
                const spreadProfiles = getSpreadProfiles();
                console.log('[JavaScript] Found ' + spreadProfiles.length + ' spread profiles');
                
                simulation.clearSpreadProfiles();
                spreadProfiles.forEach((profile, index) => {
                    console.log('[JavaScript] Adding spread profile ' + (index + 1) + ':', profile);
                    simulation.addSpreadProfile(
                        profile.global_low,
                        profile.global_high,
                        profile.alpha_loc,
                        profile.beta_loc,
                        profile.alpha_wid,
                        profile.beta_wid,
                        profile.weight
                    );
                });

                // Set L2 callback
                console.log('[JavaScript] Setting L2 callback...');
                simulation.setL2Callback(onL2Update);
                console.log('[JavaScript] L2 callback set successfully');

                // Initialize
                console.log('[JavaScript] Calling simulation.initialize()...');
                const success = simulation.initialize();
                console.log('[JavaScript] Initialize result:', success);
                
                if (!success) {
                    throw new Error('Failed to initialize simulation');
                }

                isInitialized = true;
                updateStatus('Initialized');
                elements.startBtn.disabled = false;
                elements.statusMessage.textContent = 'Simulation initialized successfully. Ready to start.';
                
                console.log('[JavaScript] Simulation initialized successfully, queue size:', simulation.getQueueSize());

            } catch (error) {
                console.error('[JavaScript] Initialization error:', error);
                showError(`Initialization failed: ${error.message}`);
                isInitialized = false;
            }
        }

        function startSimulation() {
            console.log('[JavaScript] startSimulation called, isInitialized:', isInitialized, 'isRunning:', isRunning);
            
            if (!isInitialized || isRunning) return;

            try {
                updateStatus('Starting...');
                console.log('[JavaScript] Calling simulation.start()...');
                const success = simulation.start();
                console.log('[JavaScript] Start result:', success);
                
                if (success) {
                    isRunning = true;
                    updateStatus('Running');
                    elements.startBtn.disabled = true;
                    elements.stopBtn.disabled = false;
                    elements.initBtn.disabled = true;
                    
                    console.log('[JavaScript] Simulation started, initial queue size:', simulation.getQueueSize());
                    
                    // Start monitoring queue size
                    const monitor = setInterval(() => {
                        if (!isRunning) {
                            clearInterval(monitor);
                            return;
                        }
                        const queueSize = simulation.getQueueSize();
                        updateQueueSize();
                        
                        // Log queue size changes
                        if (queueSize !== lastLoggedQueueSize) {
                            console.log('[JavaScript] Queue size changed:', queueSize);
                            lastLoggedQueueSize = queueSize;
                        }
                        
                        if (queueSize === 0) {
                            // Simulation finished
                            console.log('[JavaScript] Queue empty, stopping simulation');
                            stopSimulation();
                            updateStatus('Completed');
                            elements.statusMessage.textContent = 'Simulation completed successfully.';
                        }
                    }, 100);
                } else {
                    throw new Error('Failed to start simulation');
                }
            } catch (error) {
                console.error('[JavaScript] Start error:', error);
                showError(`Start failed: ${error.message}`);
                updateStatus('Error');
            }
        }

        function stopSimulation() {
            if (!isRunning) return;

            try {
                simulation.stop();
                isRunning = false;
                updateStatus('Stopped');
                elements.startBtn.disabled = false;
                elements.stopBtn.disabled = true;
                elements.initBtn.disabled = false;
                elements.statusMessage.textContent = 'Simulation stopped.';
            } catch (error) {
                showError(`Stop failed: ${error.message}`);
            }
        }

        // Event listeners
        elements.initBtn.addEventListener('click', initializeSimulation);
        elements.startBtn.addEventListener('click', startSimulation);
        elements.stopBtn.addEventListener('click', stopSimulation);
        elements.addSpreadProfile.addEventListener('click', () => createSpreadProfile());

        // Load WebAssembly module
        function loadModule() {
            if (typeof ExchangeSimulationModule === 'undefined') {
                showError('ExchangeSimulationModule not found. Please ensure exchange_simulation.js is loaded.');
                return;
            }

            ExchangeSimulationModule().then(module => {
                Module = module;
                elements.loading.classList.add('hidden');
                elements.mainContent.classList.remove('hidden');
                updateStatus('Ready');
                
                // Initialize default spread profiles
                initializeDefaultSpreadProfiles();
                
                console.log('WebAssembly module loaded successfully');
            }).catch(error => {
                showError(`Failed to load WebAssembly module: ${error.message}`);
                console.error('Module loading error:', error);
            });
        }

        // Auto-load when page is ready
        window.addEventListener('load', () => {
            // Small delay to ensure all scripts are loaded
            setTimeout(loadModule, 100);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (simulation) {
                simulation.cleanup();
                simulation.delete();
            }
        });
    </script>

    <!-- Load the WebAssembly module -->
    <script src="exchange_simulation.js"></script>
</body>
</html> 